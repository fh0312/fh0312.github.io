name: Create and auto-merge PR from dev to main

on:
  push:
    branches:
      - dev

jobs:
  create-pr-and-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Install GitHub CLI
        run: |
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh -y
          gh --version

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Create PR from dev to main
        run: |
          gh pr create --base main --head dev --title "Sync dev to main" --body "Auto-generated PR from dev to main" --fill

      - name: Merge PR
        run: |
          PR_NUMBER=$(gh pr list --head dev --base main --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr merge $PR_NUMBER --squash --auto --delete-branch
          else
            echo "No PR found to merge"
          fi
